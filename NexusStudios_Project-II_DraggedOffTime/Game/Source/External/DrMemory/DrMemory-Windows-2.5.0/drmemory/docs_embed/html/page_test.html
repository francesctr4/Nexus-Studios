---
title: "Test Suite"
layout: default
permalink: /page_test.html
---
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Dr. Memory
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.19 -->
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Test Suite </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md93"></a>
Automated Test Machines</h1>
<p>We use Github Actions with a setup that is similar to that [described for DynamoRIO[(<a href="https://dynamorio.org/page_test_suite.html">https://dynamorio.org/page_test_suite.html</a>).</p>
<h1><a class="anchor" id="autotoc_md94"></a>
Test Suite</h1>
<p>The test suite for Dr. Memory resides in the tests/ directory. The tests are applications that we execute under control of Dr. Memory.</p>
<h2><a class="anchor" id="autotoc_md95"></a>
Building and Running Tests</h2>
<p>The tests are built by default along with the rest of Dr. Memory.</p>
<p>CTest is used to run the tests. After building, you can use the <code>test</code> make target to run them:</p>
<div class="fragment"><div class="line">make -j6</div>
<div class="line">make test</div>
</div><!-- fragment --><p>You can also invoke <code>ctest</code> directly, which gives greater control over which subsets of the tests are run. Use <code>ctest -N</code> to see the list of tests and which number is assigned to each. Then you can use <code>ctest -I x,y</code> to run all tests from number x to number y, and the -V parameter to display the command line and the output of the test. For example:</p>
<div class="fragment"><div class="line">ctest -V -I 49,49</div>
</div><!-- fragment --><p>You can also specify tests using inclusion and exclusion regular expressions. For example:</p>
<div class="fragment"><div class="line">ctest -R <span class="stringliteral">&#39;suppress|realloc&#39;</span></div>
</div><!-- fragment --><p>will run all tests with the string "suppress" or the string "realloc" in their names, while</p>
<div class="fragment"><div class="line">ctest -E alloc</div>
</div><!-- fragment --><p>will run all tests except those with alloc in their names.</p>
<p>If you are using CTest version 2.8 or later, you can run tests in parallel by passing -jN to <code>ctest</code> on the command line:</p>
<div class="fragment"><div class="line">ctest -j5</div>
</div><!-- fragment --><p>As an alternative to using -V to display the test command line and output during executing, CTest stores that information (even when not run with -V) in the <code>Testing/Temporary/LastTest.log</code> file in the build directory.</p>
<h2><a class="anchor" id="autotoc_md96"></a>
Test Output</h2>
<p>Each test produces two types of output: stdout and the Dr. Memory results file. Both are checked against expected output, stdout versus a .out file and the results file versus a .res file. The checking is not a regular diff and simply looks for each line. We may want to change this to a stronger diff with regular expression support in the future.</p>
<h2><a class="anchor" id="autotoc_md97"></a>
Pre-Commit Test Suite</h2>
<p>The tests/runsuite.cmake script is used to execute a series of builds and test runs. Running <code>make test</code> in a single build directory is not sufficient to test all of the configurations that we support.</p>
<p>The runsuite.cmake script is meant to be executed from an empty directory. It creates a subdirectory for each build in the suite. Use <code>ctest -S</code> to execute the script. Here is an example:</p>
<div class="fragment"><div class="line">mkdir ../build_suite</div>
<div class="line">cd ../build_suite</div>
<div class="line">ctest -S ../drmemory/tests/runsuite.cmake</div>
</div><!-- fragment --><p>You can pass -V to ctest to see the results as the test suite runs. Note that it is normal to have ctest output strings such as "No tests were
found!!!" as we have builds for which we run no tests (particularly in the short suite). It is also expected to have an error at the end of the suite (if run with -V):</p>
<div class="fragment"><div class="line">CMake Error: Some required settings in the configuration file were missing:</div>
<div class="line">CTEST_SOURCE_DIRECTORY = E:/derek/drmemory/src/suite/..</div>
<div class="line">CTEST_BINARY_DIRECTORY = (Null)</div>
<div class="line">CTEST_COMMAND = c:/PROGRA~2/CMAKE2~1.6/bin/ctest.exe</div>
</div><!-- fragment --><p>This warning is an artifact of how CTest assumes we've set things up and can be ignored.</p>
<p>At the end of the suite a file called results.txt will be created and displayed. It shows configure failures, build failures, and test failures.</p>
<p>Here are sample results from running the test suite:</p>
<div class="fragment"><div class="line"><span class="preprocessor">### ============================================</span></div>
<div class="line"> </div>
<div class="line">RESULTS</div>
<div class="line"> </div>
<div class="line">drheapstat-dbg-32: all 19 tests passed</div>
<div class="line">drheapstat-rel-32: build successful; no tests <span class="keywordflow">for</span> <span class="keyword">this</span> build</div>
<div class="line">drmemory-dbg-32: all 23 tests passed</div>
<div class="line">drmemory-rel-32: build successful; no tests <span class="keywordflow">for</span> <span class="keyword">this</span> build</div>
<div class="line"><span class="keyword">final</span> package: build successful; no tests <span class="keywordflow">for</span> <span class="keyword">this</span> build</div>
<div class="line"> </div>
<div class="line">Error in read script: /home/bruening/work/build/drmem_suite/src/tests/runsuite.cmake</div>
</div><!-- fragment --><p>The "Error in read script" is expected: ignore it.</p>
<p>Here is an example of running the test suite on Windows from the cmd shell on a new checkout, with the -V flag for more verbose output:</p>
<div class="fragment"><div class="line">cd <span class="stringliteral">&quot;c:\Program Files (x86)\Microsoft Visual Studio *&quot;</span></div>
<div class="line">VC\vcvarsall.bat</div>
<div class="line"> </div>
<div class="line">set DDKROOT=C:/derek/ddk</div>
<div class="line">set FLEXROOT=C:/derek/flex_sdk_4.1</div>
<div class="line"> </div>
<div class="line">cd \derek\drmemory</div>
<div class="line">git clone https:<span class="comment">//github.com/DynamoRIO/drmemory.git</span></div>
<div class="line">cd drmemory</div>
<div class="line">make/git/devsetup.sh</div>
<div class="line"> </div>
<div class="line">cd \derek\drmemory\build_suite</div>
<div class="line"> </div>
<div class="line"><span class="stringliteral">&quot;c:\Program Files (x86)\CMake 2.8\bin\ctest.exe&quot;</span> -V -S c:/derek/drmemory/src/tests/runsuite.cmake</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md98"></a>
Embedded Versus Separate DynamoRIO</h2>
<p>DynamoRIO is included inside the Dr. Memory source tree as an svn:externals property. We support both building that embedded DR along with pointing to an already-built separate DR export tree. Whenever a new feature from DynamoRIO is used within Dr. Memory, be sure to update the svn:externals following the instructions at UpdatingDR. In addition, be sure to run the pre-commit test suite using the embedded DR, or be very careful if using an external DR that it matches the svn:externals version.</p>
<h2><a class="anchor" id="autotoc_md99"></a>
Cross-Compilation and Android Testing</h2>
<p>The test suite includes cross-compilation tests to ensure that the ARM and Android builds are not broken. If a cross-compiler is not found on the PATH, these builds will fail, but they are considered optional, so the whole suite will not be considered a failure. However, we recommend installing the cross-compilers and placing them on your PATH for more thorough testing.</p>
<p>If you have an Android device set up for access through the <code>adb shell</code> utility, the Android build is capable of automatically copying binaries to the device and running tests. If both the Android cross-compiler and <code>adb</code> are on your PATH, and <code>adb status</code> indicates an attached device, the tests will be run. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- HTML footer for doxygen 1.8.19-->
<!-- start footer part -->
<!--BEGIN GENERATE_TREEVIEW-->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer" style="float:none;text-align:center"><img border=0 src="favicon.png"> &nbsp;  Dr. Memory version 2.5.0 --- Mon Oct 18 2021 03:09:18 &nbsp; <img border=0 src="favicon.png">
</small></address>
